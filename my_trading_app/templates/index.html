<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>åŠ¨æ€æ·»åŠ è¡¨å•å¹¶å¯å…³é—­ç¤ºä¾‹</title>
  <style>
    /* é€šç”¨æ ·å¼é‡ç½® */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft YaHei", sans-serif;
    }

    body {
      /* èƒŒæ™¯é‡‡ç”¨æ¸å˜ + æš—è‰²ç³» */
      background: linear-gradient(135deg, #2c3e50, #4e2f99);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      padding: 20px 0;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(6px);
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    header h1 {
      font-size: 26px;
      letter-spacing: 2px;
      font-weight: 300;
    }

    /* ä¸»å®¹å™¨ï¼Œä½¿ç”¨ flex å¸ƒå±€æ¨ªå‘æ’åˆ—å„ä¸ªåˆ†æå— */
    #mainContainer {
      display: flex;
      flex-wrap: nowrap;
      gap: 20px;
      width: 95%;
      max-width: 1300px;
      margin: 30px auto;
      overflow-x: auto; /* å¦‚æœè¡¨å•è¿‡å¤šï¼Œå¯ä»¥æ¨ªå‘æ»šåŠ¨ */
      padding-bottom: 30px; /* é¢„ç•™ä¸‹æ–¹ç©ºé—´ */
    }

    .analysis-section {
      flex: 0 0 300px; /* æ¯ä¸ªå—çš„å®½åº¦ï¼Œå¯æ ¹æ®éœ€è¦å¾®è°ƒ */
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .analysis-section h2 {
      margin-bottom: 15px;
      font-weight: 400;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      text-align: center;
    }

    .form-group {
      margin-bottom: 12px;
    }

    label {
      display: inline-block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 4px;
    }

    button {
      display: inline-block;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 4px;
      background-color: #4CAF50;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
      margin-top: 10px;
    }
    button:hover {
      background-color: #45a049;
    }

    button.loading {
        background-color: #999 !important; /* æˆ–è€…ä½ å–œæ¬¢çš„ç¦ç”¨é¢œè‰² */
        cursor: not-allowed !important;
    }

    /* â€œå…³é—­è¡¨å•â€æŒ‰é’® */
    .close-btn {
      background-color: #e74c3c !important;
      margin-top: 0 !important;
      margin-bottom: 10px;
    }
    .close-btn:hover {
      background-color: #c0392b !important;
    }

    /* ç»“æœæ ‡é¢˜ */
    .result-title {
      font-size: 18px;
      margin: 20px 0 10px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      font-weight: 400;
    }

    /* å¡ç‰‡æ ·å¼ */
    .day-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .day-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
    }
    .day-card::before {
      content: "";
      position: absolute;
      top: 0; left: 0;
      width: 6px;
      height: 100%;
      background: linear-gradient(180deg, #00d2ff, #3a7bd5);
      border-top-left-radius: 8px;
      border-bottom-left-radius: 8px;
    }

    .day-card h3 {
      font-size: 16px;
      margin-bottom: 8px;
      font-weight: 400;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    .day-card p {
      line-height: 1.6;
      margin-bottom: 6px;
      font-size: 14px;
    }

    /* ä¿¡å·æç¤ºç‰¹æ•ˆ (å¦‚éœ€å®æ—¶ä¿¡å·æ—¶ä½¿ç”¨) */
    .signal-box {
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 16px;
      border-radius: 8px;
      margin: 10px 0;
      box-shadow: inset 0 0 10px rgba(255,255,255,0.1);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: inset 0 0 10px rgba(255,255,255,0.1); }
      50% { box-shadow: inset 0 0 20px rgba(255,255,255,0.5); }
      100% { box-shadow: inset 0 0 10px rgba(255,255,255,0.1); }
    }

    /* â€œæ·»åŠ è¡¨å•â€æŒ‰é’®ï¼Œå›ºå®šå³ä¸‹è§’ */
    #addFormBtn {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background-color: #f39c12;
      width: auto;
      padding: 15px 20px;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    #addFormBtn:hover {
      background-color: #e67e22;
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.4);
    }

    footer {
      text-align: center;
      padding: 10px 0;
      margin-top: auto;
      font-size: 14px;
      background: rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
<header>
  <h1>åŠ¨æ€æ·»åŠ è¡¨å•å¹¶å¯å…³é—­ç¤ºä¾‹</h1>
</header>

<!-- å®¹å™¨: ç”¨äºæ¨ªå‘æ’åˆ—â€œåˆ†æå—â€ -->
<div id="mainContainer">
  <!-- é»˜è®¤ä»…æ˜¾ç¤ºä¸€ä¸ªåˆ†æå—(è¡¨å• + ç»“æœ)ï¼ŒIDå›ºå®šä¸º analysisSection1 -->
  <div class="analysis-section" id="analysisSection1">
    <h2>äº¤æ˜“åˆ†æ 1</h2>

    <!-- å…³é—­è¡¨å•æŒ‰é’®ï¼ˆé»˜è®¤å—ä¹Ÿå…è®¸å…³é—­ï¼‰ -->
    <button type="button" class="close-btn" id="closeBtn1">å…³é—­è¡¨å•</button>

    <form id="analysisForm1">
      <div class="form-group">
        <label for="ts_code1">è‚¡ç¥¨ä»£ç ï¼š</label>
        <input type="text" id="ts_code1" name="ts_code1" placeholder="å¦‚ 000001.SZ" required />
      </div>
      <div class="form-group">
        <label for="start_date1">å¼€å§‹æ—¥æœŸï¼š</label>
        <input type="text" id="start_date1" name="start_date1" placeholder="å¦‚ 20220101" required />
      </div>
      <div class="form-group">
        <label for="input_year1">åˆ†æå¹´æ•°ï¼š</label>
        <input type="number" id="input_year1" name="input_year1" min="1" max="10" value="3" required />
      </div>
      <div class="form-group">
        <label for="input_money1">åˆå§‹èµ„é‡‘ï¼š</label>
        <input type="number" step="0.01" id="input_money1" name="input_money1" value="100000.00" required />
      </div>
      <div class="form-group">
        <label for="predict_option1">æ˜¯å¦é¢„æµ‹ï¼š</label>
        <select id="predict_option1" name="predict_option1">
          <option value="0">å¦</option>
          <option value="1">æ˜¯</option>
        </select>
      </div>
      <button type="submit" id="submitBtn1">å¼€å§‹ç›‘å¬</button>
    </form>
    <!-- å®æ—¶æ•°æ®å¡ç‰‡ï¼ˆåˆå§‹éšè—ï¼‰ -->
    <div class="day-card" id="realtimeCard1" style="display: none;">
      <h3>å®æ—¶æ•°æ®</h3>
      <div id="realtimeOutput1" style="white-space: pre-wrap; font-size:14px;"></div>
    </div>
    <!-- å›æµ‹ç»“æœå±•ç¤ºåŒºåŸŸ -->
    <div id="analysisResult1"></div>

  </div>
</div>

<!-- â€œæ·»åŠ è¡¨å•â€æŒ‰é’® -->
<button id="addFormBtn">æ·»åŠ è¡¨å•</button>

<footer>
  Â© 2025 äº¤æ˜“ç³»ç»Ÿç¤ºä¾‹
</footer>

<script>
  // å½“å‰å·²æœ‰çš„è¡¨å•æ•°é‡
  let formCount = 1;

  // å­˜å‚¨å„è¡¨å•çš„è½®è¯¢å®šæ—¶å™¨IDï¼Œå…³é—­è¡¨å•æ—¶éœ€æ¸…é™¤
  const pollIntervals = {};

  const mainContainer = document.getElementById("mainContainer");
  const addFormBtn = document.getElementById("addFormBtn");

  // ============ å¤„ç†é»˜è®¤å—çš„â€œå…³é—­è¡¨å•â€äº‹ä»¶ =============
  const defaultCloseBtn = document.getElementById("closeBtn1");
  const defaultSection = document.getElementById("analysisSection1");
  defaultCloseBtn.addEventListener("click", () => {
    // å¦‚æœæœ‰è½®è¯¢ï¼Œå…ˆæ¸…é™¤
    if (pollIntervals[1]) {
      clearInterval(pollIntervals[1]);
      delete pollIntervals[1];
    }
    mainContainer.removeChild(defaultSection);
  });

  // ============ é»˜è®¤ç¬¬1ä¸ªè¡¨å•å¤„ç†æäº¤äº‹ä»¶ =============
  const analysisForm1 = document.getElementById("analysisForm1");
  const resultContainer1 = document.getElementById("analysisResult1");
  const realtimeCard1 = document.getElementById("realtimeCard1");   // å®æ—¶æ•°æ®å¡ç‰‡
  const realtimeOutput1 = document.getElementById("realtimeOutput1"); // å®æ—¶æ•°æ®æ˜¾ç¤ºåŒºåŸŸ

  analysisForm1.addEventListener("submit", function(event) {
    event.preventDefault();

    // å¦‚æœä¹‹å‰å·²ç»å¼€å¯äº†è½®è¯¢ï¼Œè¦å…ˆåœæ­¢ï¼ˆé¿å…é‡å¤å¼€å¯ï¼‰
    if (pollIntervals[1]) {
      clearInterval(pollIntervals[1]);
      delete pollIntervals[1];
    }

      // 1) ç¦ç”¨æ•´ä¸ªè¡¨å•
      disableForm(analysisForm1);

      // 2) ä¿®æ”¹æŒ‰é’®æ–‡å­—å’Œæ ·å¼
      submitBtn1.textContent = "ç›‘å¬ä¸­";
      submitBtn1.classList.add("loading");

    // è·å–ç”¨æˆ·è¾“å…¥
    const ts_code = document.getElementById("ts_code1").value;
    const start_date = document.getElementById("start_date1").value;
    const input_year = document.getElementById("input_year1").value;
    const input_money = document.getElementById("input_money1").value;
    const predict_option = document.getElementById("predict_option1").value;

    const postData = {
      ts_code,
      start_date,
      input_year,
      input_money,
      predict_option
    };

    // è°ƒç”¨åç«¯æ¥å£(å‡è®¾ /api/analyze å­˜åœ¨å¹¶è¿”å› JSON)
    fetch("/api/analyze", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(postData)
    })
            .then(res => res.json())
            .then(data => {
              if(data.error) {
                  // è¿™é‡Œå¦‚æœä½ æƒ³æ¢å¤è¡¨å•ï¼Œè®©ç”¨æˆ·é‡æ–°ä¿®æ”¹ï¼Œå¯é‡æ–°å¯ç”¨
                  enableForm(analysisForm1);
                  submitBtn1.textContent = "å¼€å§‹ç›‘å¬";
                  submitBtn1.classList.remove("loading");
                // å¦‚æœåç«¯è¿”å›äº† error
                resultContainer1.innerHTML = `<p style="color: red;">å‡ºç°é”™è¯¯: ${data.error}</p>`;
                // éšè—å®æ—¶æ•°æ®å¡ç‰‡
                realtimeCard1.style.display = "none";
              } else {
                // å°†æ—¥å¿—å’Œé¢„æµ‹ç»“æœæ¸²æŸ“ä¸º day-card æ ·å¼
                let html = "";

                // é¢„æµ‹ç»“æœ
                if(data.prediction) {
                  const p = data.prediction;
                  html += `<div class="day-card">`;
                  html += `<h3>é¢„æµ‹ç»“æœ</h3>`;
                  html += `<p>é¢„æµ‹å¼€ç›˜ä»·: ${p.predicted_open.toFixed(2)}</p>`;
                  html += `<p>é¢„æµ‹æœ€é«˜ä»·: ${p.predicted_high.toFixed(2)}</p>`;
                  html += `<p>é¢„æµ‹æœ€ä½ä»·: ${p.predicted_low.toFixed(2)}</p>`;
                  html += `<p>é¢„æµ‹æ”¶ç›˜ä»·: ${p.predicted_close.toFixed(2)}</p>`;
                  html += `</div>`;
                }

                // å›æµ‹æ—¥å¿—
                if(Array.isArray(data.logs)) {
                  data.logs.forEach((item, idx) => {
                    html += `<div class="day-card">`;
                    if(item.action === "åˆå§‹ä¹°å…¥") {
                      html += `<h3>${item.trade_date} (åˆå§‹ä¹°å…¥)</h3>`;
                      html += `<p>ä¹°å…¥ä»·: ${item.price}</p>`;
                      // è´¦æˆ·çŠ¶æ€å¯¹è±¡ -> ç¾åŒ–å­—ç¬¦ä¸²
                      html += `<p>è´¦æˆ·çŠ¶æ€: ${formatAccountStatus(item.account_status)}</p>`;
                    } else {
                      html += `<h3>æ—¥æœŸ: ${item.trade_date}</h3>`;
                      html += `<p>å¼€: ${item.open?.toFixed(2)}, é«˜: ${item.high?.toFixed(2)},
                       ä½: ${item.low?.toFixed(2)}, æ”¶: ${item.close?.toFixed(2)}</p>`;
                      html += `<p>æˆäº¤é‡: ${item.vol?.toFixed(0)}, ä¿¡å·: ${item.signal}</p>`;
                      html += `<p>è´¦æˆ·çŠ¶æ€: ${formatAccountStatus(item.account_status)}</p>`;
                    }
                    html += `</div>`;
                  });
                }



                resultContainer1.innerHTML = html || "<p>æ²¡æœ‰å›æµ‹æ•°æ®</p>";

                // =========== å¼€å¯å®æ—¶æ•°æ®è½®è¯¢ ===========
                realtimeCard1.style.display = "block"; // æ˜¾ç¤ºå®æ—¶å¡ç‰‡
                realtimeOutput1.textContent = "æ­£åœ¨åŠ è½½å®æ—¶æ•°æ®..."; // åˆå§‹æç¤º

                // æ¯ 5 ç§’è¯·æ±‚ä¸€æ¬¡ /api/realtime?ts_code=xxx
                pollIntervals[1] = setInterval(() => {
                // pollIntervals[1] =
                  fetch(`/api/realtime?ts_code=${ts_code}`)
                          .then(r => r.json())
                          .then(rtData => {
                            if(rtData.error) {
                              realtimeOutput1.innerHTML = `<p style="color:red;">å®æ—¶æ•°æ®é”™è¯¯: ${rtData.error}</p>`;
                            } else {
                              // å°†æ•°æ®è§£æ„å‡ºæ¥ï¼Œæ–¹ä¾¿ä½¿ç”¨
                              const {
                                current_time,     // å½¢å¦‚ "16:55:11"
                                trade_date,       // å½¢å¦‚ "20250116"
                                open, high, low, close,
                                vol,
                                signal_message,   // "ğŸ”” ä¿¡å·æç¤º: ä¹°å…¥\n(002031.SZ, å½“å‰ä»·: 6.58)"
                                account_status
                              } = rtData;

                              // ä½¿ç”¨ HTML æ ‡è®°æ¥ç¾åŒ–è¾“å‡º
                              let rtHtml = "<div style=\"line-height:1.8;\">" +
                                      "<p><strong>æ—¶é—´ï¼š</strong>"+ current_time +"</p>" +
                                      "<p><strong>æ—¥æœŸï¼š</strong>" + trade_date +"</p>" +
                                      "<p><strong>ä»·æ ¼ï¼š</strong>" +
                                      "å¼€ç›˜ä»·: "+ open.toFixed(2) +
                                      "æœ€é«˜ä»·: "+ high.toFixed(2) +
                                      "æœ€ä½ä»·: "+ low.toFixed(2) +
                                      "å½“å‰ä»·: "+ close.toFixed(2) +"</p>" +
                                      "<p><strong>æˆäº¤é‡ï¼š</strong>"+vol.toFixed(0)+"</p>" +
                                      "<p><strong>ä¿¡å·ï¼š</strong><span style=\"color:#ffcc00;\">"+signal_message+"</span></p>" +
                                      "<p><strong>è´¦æˆ·çŠ¶æ€ï¼š</strong>" + formatAccountStatus(account_status) +"</p></div>";

                              // æ³¨æ„: å¦‚æœæƒ³è®©å­—ç¬¦ä¸²å½“ä½œHTMLè§£æï¼Œè¦ç”¨innerHTML
                              realtimeOutput1.innerHTML = rtHtml;
                            }
                          })
                          .catch(err => {
                              // åŒç†ï¼Œå‡ºç°ç½‘ç»œé”™è¯¯ä¹Ÿå¯é€‰æ‹©æ¢å¤è¡¨å•
                              enableForm(analysisForm1);
                              submitBtn1.textContent = "å¼€å§‹ç›‘å¬";
                              submitBtn1.classList.remove("loading");
                            realtimeOutput1.innerHTML = `<p style="color:red;">å®æ—¶è¯·æ±‚å‡ºé”™: ${err}</p>`;
                          });
                }, 5000);
              }
            })
            .catch(err => {
              console.error(err);
              resultContainer1.innerHTML = `<p style="color: red;">è¯·æ±‚å‡ºé”™: ${err}</p>`;
              realtimeCard1.style.display = "none";
            });
  });
  /** ç¦ç”¨æ•´ä¸ªè¡¨å•é‡Œçš„æ‰€æœ‰å…ƒç´  */
  function disableForm(form) {
      Array.from(form.elements).forEach(el => {
          el.disabled = true;
      });
  }

  /** å¯ç”¨æ•´ä¸ªè¡¨å•é‡Œçš„æ‰€æœ‰å…ƒç´  */
  function enableForm(form) {
      Array.from(form.elements).forEach(el => {
          el.disabled = false;
      });
  }
  // ============ â€œæ·»åŠ è¡¨å•â€æŒ‰é’®é€»è¾‘ =============
  addFormBtn.addEventListener("click", function() {
    formCount++;
    // æ–°å»ºä¸€ä¸ª analysis-section å—
    const newSection = document.createElement("div");
    newSection.className = "analysis-section";
    newSection.id = "analysisSection" + formCount;

    const closeBtnId = "closeBtn" + formCount;
    const formId = "analysisForm" + formCount;
    const resultId = "analysisResult" + formCount;
    const realtimeCardId = "realtimeCard" + formCount;
    const realtimeOutputId = "realtimeOutput" + formCount;

    // æ‹¼æ¥HTMLï¼ŒåŒ…å«â€œå…³é—­è¡¨å•â€æŒ‰é’®ã€è¡¨å•ã€å›æµ‹ç»“æœåŒºã€å®æ—¶æ•°æ®å¡ç‰‡
    const sectionHtml = `
      <h2>äº¤æ˜“åˆ†æ ${formCount}</h2>
      <button type="button" class="close-btn" id="${closeBtnId}">å…³é—­è¡¨å•</button>

      <form id="${formId}">
        <div class="form-group">
          <label for="ts_code${formCount}">è‚¡ç¥¨ä»£ç ï¼š</label>
          <input type="text" id="ts_code${formCount}" name="ts_code${formCount}" placeholder="å¦‚ 000001.SZ" required />
        </div>
        <div class="form-group">
          <label for="start_date${formCount}">å¼€å§‹æ—¥æœŸï¼š</label>
          <input type="text" id="start_date${formCount}" name="start_date${formCount}" placeholder="å¦‚ 20220101" required />
        </div>
        <div class="form-group">
          <label for="input_year${formCount}">åˆ†æå¹´æ•°ï¼š</label>
          <input type="number" id="input_year${formCount}" name="input_year${formCount}" min="1" max="10" value="3" required />
        </div>
        <div class="form-group">
          <label for="input_money${formCount}">åˆå§‹èµ„é‡‘ï¼š</label>
          <input type="number" step="0.01" id="input_money${formCount}" name="input_money${formCount}" value="100000.00" required />
        </div>
        <div class="form-group">
          <label for="predict_option${formCount}">æ˜¯å¦é¢„æµ‹ï¼š</label>
          <select id="predict_option${formCount}" name="predict_option${formCount}">
            <option value="0">å¦</option>
            <option value="1">æ˜¯</option>
          </select>
        </div>
        <button type="submit" id="submitBtn${formCount}">å¼€å§‹ç›‘å¬</button>
      </form>
       <!-- å®æ—¶æ•°æ®å¡ç‰‡ï¼Œåˆå§‹éšè— -->
      <div class="day-card" id="${realtimeCardId}" style="display: none;">
        <h3>å®æ—¶æ•°æ®</h3>
        <div id="${realtimeOutputId}" style="white-space: pre-wrap; font-size:14px;"></div>
      </div>
      <div id="${resultId}"></div>

    `;
    newSection.innerHTML = sectionHtml;
    mainContainer.appendChild(newSection);

    // å–å‡ºåˆšåˆ›å»ºçš„æŒ‰é’®ã€è¡¨å•ã€ç»“æœåŒºã€å®æ—¶åŒº
    const closeBtn = document.getElementById(closeBtnId);
    const newForm = document.getElementById(formId);
    const newResult = document.getElementById(resultId);
    const realtimeCard = document.getElementById(realtimeCardId);
    const realtimeOutput = document.getElementById(realtimeOutputId);

    // ä¸ºâ€œå…³é—­è¡¨å•â€æŒ‰é’®ç»‘å®šäº‹ä»¶ï¼Œç‚¹å‡»åç§»é™¤æ•´ä¸ªå— & åœæ­¢è½®è¯¢
    closeBtn.addEventListener("click", () => {
      if (pollIntervals[formCount]) {
        clearInterval(pollIntervals[formCount]);
        delete pollIntervals[formCount];
      }
      mainContainer.removeChild(newSection);
    });

    // æäº¤äº‹ä»¶
    newForm.addEventListener("submit", function(e) {
      e.preventDefault();

      // å¦‚æœä¹‹å‰å·²ç»å¼€å¯äº†è½®è¯¢ï¼Œè¦å…ˆåœæ­¢
      if (pollIntervals[formCount]) {
        clearInterval(pollIntervals[formCount]);
        delete pollIntervals[formCount];
      }

        // 1) ç¦ç”¨æ•´ä¸ªè¡¨å•
        disableForm(newForm);

        // 2) ä¿®æ”¹æŒ‰é’®æ–‡å­—å’Œæ ·å¼
        const submitNew = document.getElementById("submitBtn" + formCount);
        submitNew.textContent = "ç›‘å¬ä¸­";
        submitNew.classList.add("loading");

      // è·å–è¾“å…¥
      const ts_code = document.getElementById("ts_code" + formCount).value;
      const start_date = document.getElementById("start_date" + formCount).value;
      const input_year = document.getElementById("input_year" + formCount).value;
      const input_money = document.getElementById("input_money" + formCount).value;
      const predict_option = document.getElementById("predict_option" + formCount).value;

      const postData = {
        ts_code,
        start_date,
        input_year,
        input_money,
        predict_option
      };

      // å‘è¯·æ±‚åˆ°åç«¯ /api/analyze
      fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(postData)
      })
              .then(res => res.json())
              .then(data => {
                if(data.error) {
                    // è¿™é‡Œå¦‚æœä½ æƒ³æ¢å¤è¡¨å•ï¼Œè®©ç”¨æˆ·é‡æ–°ä¿®æ”¹ï¼Œå¯é‡æ–°å¯ç”¨
                    enableForm(newForm);
                    const submitNew = document.getElementById("submitBtn" + formCount);
                    submitNew.textContent = "å¼€å§‹ç›‘å¬";
                    submitNew.classList.remove("loading");
                  newResult.innerHTML = `<p style="color: red;">å‡ºç°é”™è¯¯: ${data.error}</p>`;
                  realtimeCard.style.display = "none";
                } else {
                  let html = "";
                    // é¢„æµ‹ç»“æœ
                    if(data.prediction) {
                        const p = data.prediction;
                        html += `<div class="day-card">`;
                        html += `<h3>é¢„æµ‹ç»“æœ1</h3>`;
                        html += `<p>é¢„æµ‹å¼€ç›˜ä»·: ${p.predicted_open.toFixed(2)}</p>`;
                        html += `<p>é¢„æµ‹æœ€é«˜ä»·: ${p.predicted_high.toFixed(2)}</p>`;
                        html += `<p>é¢„æµ‹æœ€ä½ä»·: ${p.predicted_low.toFixed(2)}</p>`;
                        html += `<p>é¢„æµ‹æ”¶ç›˜ä»·: ${p.predicted_close.toFixed(2)}</p>`;
                        html += `</div>`;
                    }
                  // å›æµ‹æ—¥å¿—
                  if(Array.isArray(data.logs)) {
                    data.logs.forEach(item => {
                      html += `<div class="day-card">`;
                      if(item.action === "åˆå§‹ä¹°å…¥") {
                        html += `<h3>${item.trade_date} (åˆå§‹ä¹°å…¥)</h3>`;
                        html += `<p>ä¹°å…¥ä»·: ${item.price}</p>`;
                        html += `<p>è´¦æˆ·çŠ¶æ€: ${formatAccountStatus(item.account_status)}</p>`;
                      } else {
                        html += `<h3>æ—¥æœŸ: ${item.trade_date}</h3>`;
                        html += `<p>å¼€: ${item.open?.toFixed(2)}, é«˜: ${item.high?.toFixed(2)},
                         ä½: ${item.low?.toFixed(2)}, æ”¶: ${item.close?.toFixed(2)}</p>`;
                        html += `<p>æˆäº¤é‡: ${item.vol?.toFixed(0)}, ä¿¡å·: ${item.signal}</p>`;
                        html += `<p>è´¦æˆ·çŠ¶æ€: ${formatAccountStatus(item.account_status)}</p>`;
                      }
                      html += `</div>`;
                    });
                  }


                  newResult.innerHTML = html || "<p>æ²¡æœ‰å›æµ‹æ•°æ®</p>";

                  // =========== å¼€å¯å®æ—¶æ•°æ®è½®è¯¢ ===========
                  realtimeCard.style.display = "block";
                  realtimeOutput.textContent = "æ­£åœ¨åŠ è½½å®æ—¶æ•°æ®...";

                  pollIntervals[formCount] = setInterval(() => {
                    fetch(`/api/realtime?ts_code=${ts_code}`)
                            .then(r => r.json())
                            .then(rtData => {
                              if(rtData.error) {
                                realtimeOutput.innerHTML = `<p style="color:red;">å®æ—¶æ•°æ®é”™è¯¯: ${rtData.error}</p>`;
                              } else {
                                  const {
                                      current_time,     // å½¢å¦‚ "16:55:11"
                                      trade_date,       // å½¢å¦‚ "20250116"
                                      open, high, low, close,
                                      vol,
                                      signal_message,   // "ğŸ”” ä¿¡å·æç¤º: ä¹°å…¥\n(002031.SZ, å½“å‰ä»·: 6.58)"
                                      account_status
                                  } = rtData;
                                  let rtHtml = "<div style=\"line-height:1.8;\">" +
                                          "<p><strong>æ—¶é—´ï¼š</strong>"+ current_time +"</p>" +
                                          "<p><strong>æ—¥æœŸï¼š</strong>" + trade_date +"</p>" +
                                          "<p><strong>ä»·æ ¼ï¼š</strong>" +
                                          "å¼€ç›˜ä»·: "+ open.toFixed(2) +
                                          "æœ€é«˜ä»·: "+ high.toFixed(2) +
                                          "æœ€ä½ä»·: "+ low.toFixed(2) +
                                          "å½“å‰ä»·: "+ close.toFixed(2) +"</p>" +
                                          "<p><strong>æˆäº¤é‡ï¼š</strong>"+vol.toFixed(0)+"</p>" +
                                          "<p><strong>ä¿¡å·ï¼š</strong><span style=\"color:#ffcc00;\">"+signal_message+"</span></p>" +
                                          "<p><strong>è´¦æˆ·çŠ¶æ€ï¼š</strong>" + formatAccountStatus(account_status) +"</p></div>";

                                  realtimeOutput.innerHTML = rtHtml;
                              }
                            })
                            .catch(err => {
                                // è¿™é‡Œå¦‚æœä½ æƒ³æ¢å¤è¡¨å•ï¼Œè®©ç”¨æˆ·é‡æ–°ä¿®æ”¹ï¼Œå¯é‡æ–°å¯ç”¨
                                enableForm(newForm);
                                const submitNew = document.getElementById("submitBtn" + formCount);
                                submitNew.textContent = "å¼€å§‹ç›‘å¬";
                                submitNew.classList.remove("loading");
                              realtimeOutput.innerHTML = `<p style="color:red;">å®æ—¶è¯·æ±‚å‡ºé”™: ${err}</p>`;
                            });
                  }, 5000);
                }
              })
              .catch(err => {
                console.error(err);
                newResult.innerHTML = `<p style="color: red;">è¯·æ±‚å‡ºé”™: ${err}</p>`;
                realtimeCard.style.display = "none";
              });
    });
  });

  /**
   * ç¾åŒ–æ˜¾ç¤ºè´¦æˆ·çŠ¶æ€(å­—å…¸)
   * @param {object} accStat
   */
  function formatAccountStatus(accStat){
    if(!accStat) return "æ— è´¦æˆ·ä¿¡æ¯";
    // ä¾‹å¦‚: ä½™é¢:100000, æŒä»“:20000, æˆæœ¬ä»·:5.32, æµ®ç›ˆ:300.0, æ€»èµ„äº§: 106300, æ”¶ç›Š:6300
    return `ä½™é¢:${accStat.balance}, æŒä»“:${accStat.position}, æˆæœ¬ä»·:${accStat.hold_price}, `
            + `æµ®ç›ˆ:${accStat.unrealized_pnl}, æ€»èµ„äº§:${accStat.total_assets}, æ”¶ç›Š:${accStat.profit_loss}`;
  }
</script>
</body>
</html>
